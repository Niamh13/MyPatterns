name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "$SSH_PRIVATE_KEY" > myKey.pem
          chmod 600 myKey.pem

      - name: Deploy to EC2
        run: |
          ELASTIC_IP=3.215.208.4

          ssh -o StrictHostKeyChecking=no -i myKey.pem ubuntu@${ELASTIC_IP} << 'EOF'
            set -e

            # --- SYSTEM DEPENDENCIES ---
            sudo apt update -y
            sudo apt install -y git build-essential curl

            # --- INSTALL mise IF MISSING ---
            if ! command -v mise &> /dev/null; then
              curl https://mise.jdx.dev/install.sh | sh
              echo 'export PATH="$HOME/.local/share/mise/bin:$PATH"' >> ~/.bashrc
              export PATH="$HOME/.local/share/mise/bin:$PATH"
            fi

            # --- INSTALL RUBY WITH mise ---
            # Reads .tool-versions from your repo automatically
            mise install ruby

            # Ensure Ruby is on PATH
            export PATH="$HOME/.local/share/mise/installs/ruby/3.4.7/bin:$PATH"

            # --- CLONE LATEST CODE ---
            rm -rf MyPatterns
            git clone https://github.com/Niamh13/MyPatterns.git
            cd MyPatterns

            # --- INSTALL GEM DEPENDENCIES ---
            gem install bundler --no-document
            bundle install

            # --- SECURITY + LINTING TOOLS ---
            bundle exec bundler-audit update
            bundle exec brakeman --no-pager
            bundle exec rubocop --autocorrect-all --disable-uncorrectable

            # --- DATABASE MIGRATIONS ---
            bundle exec rails db:migrate

            # --- START SERVER ---
            chmod +x startServer.sh
            ./startServer.sh
          EOF

      - name: Cleanup
        run: rm -f myKey.pem
